{{#each timeline as timelineEvent, index @slug}}
	{{#if timelineEvent.axis.end === timelineEvent.axis.start}}
		<VCenter
			left="{{multiplyIndentByWidth(timelineEvent.indentLevel)}}"
			point="{{multiplyDaysByHeight(timelineEvent.axisAfterStart)}}"
		>
			<Visibility
				bind:visible="visibleEventSlugs[timelineEvent.slug]"
				bind:topRatio="slugToTopRatio[timelineEvent.slug]"
				bind:top="slugToTop[timelineEvent.slug]"
				bind:bottom="slugToBottom[timelineEvent.slug]"
				bind:bottomRatio="slugToBottomRatio[timelineEvent.slug]"
				bind:right="slugToRight[timelineEvent.slug]"
				logName="Events single: {{timelineEvent.slug}}"
				updateOnChange="{{index}}"
			>
				<div
					class="event"
					style="
						height: {{singleDayHeight}}px;
						background-color: {{timelineEvent.color}};
					"
					on:mouseover="fire('startHover', timelineEvent)"
					on:mouseleave="fire('endHover', timelineEvent)"
				/>
			</Visibility>
		</VCenter>
	{{else}}
		<Link
			parameters="{{ clickable ? { zoom: timelineEvent.slug } : null }}"
		>
			<Visibility
				bind:visible="visibleEventSlugs[timelineEvent.slug]"
				bind:topRatio="slugToTopRatio[timelineEvent.slug]"
				bind:top="slugToTop[timelineEvent.slug]"
				bind:bottom="slugToBottom[timelineEvent.slug]"
				bind:bottomRatio="slugToBottomRatio[timelineEvent.slug]"
				bind:right="slugToRight[timelineEvent.slug]"
				logName="Events long: {{timelineEvent.slug}}"
				updateOnChange="{{index}}"
			>
				<div
					id="{{timelineEvent.slug}}"
					style="
						top: {{multiplyDaysByHeight(timelineEvent.axisAfterStart)}}px;
						left: {{multiplyIndentByWidth(timelineEvent.indentLevel)}}px;
						height: {{multiplyDaysByHeight(timelineEvent.visibleDays)}}px;
						background-color: {{timelineEvent.color}};
					"
					class="event"
					data-cut-off-at-start="{{timelineEvent.axis.cutOffAtStart}}"
					data-cut-off-at-end="{{timelineEvent.axis.cutOffAtEnd}}"
					on:mouseover="fire('startHover', timelineEvent)"
					on:mouseleave="fire('endHover', timelineEvent)"
				/>
			</Visibility>
		</Link>
	{{/if}}
{{/each}}

<style>
[data-clickable=true] {
	cursor: pointer;
}
.event {
	position: absolute;

	width: 48px;
	-webkit-border-radius: 10px;
	-moz-border-radius: 10px;
	border-radius: 10px;
}
.event[data-cut-off-at-start=true] {
	-webkit-border-top-right-radius: 0;
	-webkit-border-top-left-radius: 0;
	border-top-right-radius: 0;
	border-top-left-radius: 0;
}
.event[data-cut-off-at-end=true] {
	-webkit-border-bottom-right-radius: 0;
	-webkit-border-bottom-left-radius: 0;
	border-bottom-right-radius: 0;
	border-bottom-left-radius: 0;
}
.event:hover {
	background-color: red;
}

</style>

<script>
import Visibility from './Visibility.html'
import VCenter from './VerticallyCentered.html'

import { multiplyIndentByWidth } from './spacer-functions.js'
import svelteQuerystringRouter from 'svelte-querystring-router'

export default {
	data() {
		const empty = () => Object.create(null)
		return {
			clickable: false,
			visibleEventSlugs: empty(),
			slugToTopRatio: empty(),
			slugToBottomRatio: empty(),
			slugToTop: empty(),
			slugToBottom: empty(),
			slugToRight: empty(),
			ignoreType: []
		}
	},
	helpers: {
		multiplyIndentByWidth,
	},
	computed: {
		multiplyDaysByHeight: dayHeight => days => days * dayHeight,
		singleDayHeight: dayHeight => Math.max(dayHeight, 8),
		ignoreTypeMap: ignoreType => ignoreType.reduce((map, type) => (map[type] = true, map), Object.create(null)),
		nonIgnoredEvents: (timeline, ignoreTypeMap) => timeline.filter(event => !ignoreTypeMap[event.type]),
		visibleEvents: (nonIgnoredEvents, visibleEventSlugs, slugToTopRatio, slugToBottomRatio, slugToTop, slugToBottom, slugToRight) => nonIgnoredEvents
			.filter(event => visibleEventSlugs[event.slug])
			.map(event => Object.assign({
				topRatio: slugToTopRatio[event.slug],
				bottomRatio: slugToBottomRatio[event.slug],
				top: slugToTop[event.slug],
				bottom: slugToBottom[event.slug],
				right: slugToRight[event.slug],
			}, event)),
	},
	components: {
		VCenter,
		Link: svelteQuerystringRouter.Link,
		Visibility
	},
}
</script>
