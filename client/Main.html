{{#if hoveredEvent}}
<div class="eventhover">
	{{hoveredEvent.title}} ({{hoveredEvent.hebrew.start}} to {{hoveredEvent.hebrew.end}})
</div>
{{/if}}
<div class="timeline-container">
	{{#each relevantTimelineData as timelineEvent}}
		<div 
			class="event" 
			data-title="{{timelineEvent.title}}" 
			data-start="{{timelineEvent.amd.start}}" 
			data-end="{{timelineEvent.amd.end}}"
			style="
				top: {{multiplyDaysByHeight(timelineEvent.daysAfterStart)}}; 
				height: {{multiplyDaysByHeight(timelineEvent.amd.end - timelineEvent.amd.start)}};
				left: {{multiplyIndentByWidth(timelineEvent.indentLevel)}};
			"
			on:mouseover="startHover(timelineEvent)"
			on:mouseleave="endHover(timelineEvent)"

		>
			
		</div>
	{{/each}}	
</div>

<style>
.timeline-container {
	position: relative;
}
.event {
	position: absolute;
	width: 16px;
	-webkit-border-radius: 10px;
	-moz-border-radius: 10px;
	border-radius: 10px;

	background-color: green;
}

.eventhover {
	position: fixed;
	top: 0;
	left: 0;
	padding: 10px;
}
</style>

<script>
function mapKnowingPrevious(ary, fn) {
	let last = null
	return ary.map(current => {
		const transformed = fn(current, last)
		last = transformed
		return transformed
	})
}

export default {
	computed: {
		relevantTimelineData: timelineData => {
			const relevantEvents = timelineData.filter(
				event => event.amd.end > 1471937 && event.amd.start < 1488003
			)
			const startDay = relevantEvents[0].amd.start

			return mapKnowingPrevious(
				relevantEvents,
				(event, previous) => {
					const calculatedIndentLevel = () => previous.amd.end >= event.amd.start 
						? previous.indentLevel + 1 
						: previous.indentLevel

					const gapBefore = previous ? event.amd.start - previous.amd.end : 0
					const indentLevel = previous ? calculatedIndentLevel() : 0

					return Object.assign({
						gapBefore,
						indentLevel,
						daysAfterStart: event.amd.start - startDay
					}, event)
				}
			)
		}
	},
	helpers: {
		multiplyDaysByHeight(days) {
			return ((days + 1) * 3) + 'px'
		},
		multiplyIndentByWidth(indentLevel) {
			return (indentLevel * 20) + 'px'
		}
	},
	methods: {
		startHover(event) {
			this.set({
				hoveredEvent: event
			})
		},
		endHover() {
			this.set({
				hoveredEvent: null
			})
		}
	}
}
</script>
