{{#if hoveredEvent}}
<div class="eventhover">
	{{hoveredEvent.title}} {{#if hoveredEvent.reference}}({{hoveredEvent.reference}}){{/if}}
</div>
{{/if}}
<!--<button class="btn-default" id="zoombutton" on:click="toggleZoom()">Zoom {{#if zoomedIn}}out{{else}}in{{/if}}</button>-->
<div class="timeline-container">
	<div class="timeline-row" style="width: 100px; margin-right: 10px;">
		{{#each axis as date}}
		<VCenter point="{{multiplyDaysByHeight(distanceFromStartDay(date.axisPoint))}}">
			<div class="axis" data-relevant="{{axisIsRelevant(date.amd)}}">
				{{#if date.type === 'snip'}}
				...snip ({{date.days}} days)
				{{else}}
				{{date.hebrew || date.amd}}
				{{/if}}			
			</div>
		</VCenter>
		{{/each}}		
	</div>
	<div class="timeline-row" style="width: 250px">
		<Events 
			timeline="{{relevantEventsWithAxis}}" 
			on:startHover="startHover(event)" 
			on:endHover="endHover(event)" 
			dayHeight="{{currentZoom.dayHeight}}"
		/>
	</div>
</div>

<style>
.timeline-container {
	display: flex;
	flex-wrap: nowrap;
	align-items: flex-start;
}
.timeline-row {
	position: relative;
}
.axis {
	font-size: 10px;
	width: 100px;
	text-align: right;
}
.axis[data-relevant=true] {
	color: red;
}
.event {
	width: 16px;
	-webkit-border-radius: 10px;
	-moz-border-radius: 10px;
	border-radius: 10px;

	background-color: green;
}
.event:hover {
	background-color: red;
}

.eventhover {
	z-index: 1;
	position: fixed;
	top: 0;
	left: 0;
	padding: 10px;
	background-color: white;
	background-color: rgba(255, 255, 255, 0.8);
}
#zoombutton {
	z-index: 1;
	position: fixed;
	top: 0;	
	right: 0;
}
</style>

<script>
import VCenter from './VerticallyCentered.html'
import Events from './Events.html'

import createTimelineAxis from './create-timeline-axis.js'
import addAxisPoints from '../timeline-data/add-axis-points-to-timeline-data.js'

import { multiplyIndentByWidth } from './spacer-functions.js'

function createIndentLevelCalculator() {
	const indentLevels = []

	return event => {
		const eventDate = event.amd
		const replaceIndent = indentLevels.findIndex(previousDate => previousDate.end < eventDate.start)
		if (replaceIndent === -1) {
			indentLevels.push(eventDate)
			return indentLevels.length - 1
		} else {
			indentLevels[replaceIndent] = eventDate
			return replaceIndent
		}
	}
}

function addIndentAndAxisAfterStart(events, startDay, endDay) {
	const getIndentLevel = createIndentLevelCalculator()

	return events.map(event => {
		const axisAfterStart = Math.max(event.axis.start - startDay, 0)
		const eventDays = event.axis.end - event.axis.start + 1
		const daysBeforeStart = Math.max(startDay - event.axis.start, 0)
		const daysAfterEnd = Math.max(event.axis.end - endDay, 0)

		const visibleDays = eventDays - daysBeforeStart - daysAfterEnd

		return Object.assign({
			indentLevel: getIndentLevel(event),
			axisAfterStart,
			visibleDays
		}, event)		
	})
}

const zooms = {
	top: {
		dayHeight: 0.1,
		start: 1471937,
		end: 1488003,
		snipSectionsLongerThan: 10000,
		snipBuffer: 1500,
		type: 'top',
	},
	default: {
		dayHeight: 10,
		type: null
	}
}

export default {
	data() {
		return zooms.top
	},
	computed: {
		multiplyDaysByHeight: currentZoom => days => days * currentZoom.dayHeight,
		relevantEvents: (timelineData, currentZoom) => timelineData
			.filter(event => 
				(event.amd.end >= currentZoom.start || event.amd.start <= currentZoom.end)
				&& (!currentZoom.type || currentZoom.type === event.type)
			)
			.sort((a, b) => a.amd - b.amd),
		axis: (relevantEvents, currentZoom) => createTimelineAxis({
			timelineData: relevantEvents, 
			snipSectionsLongerThan: currentZoom.snipSectionsLongerThan,
			snipBuffer: currentZoom.snipBuffer,
			start: currentZoom.start,
			end: currentZoom.end,
		}),
		relevantEventsWithAxis: (axis, relevantEvents, currentZoom) => addIndentAndAxisAfterStart(
			addAxisPoints(axis, relevantEvents), currentZoom.start, currentZoom.end
		),
		distanceFromStartDay: currentZoom => day => day - currentZoom.start,
		axisIsRelevant: hoveredEvent => amdDay => !!hoveredEvent 
			&& (hoveredEvent.amd.start === amdDay || hoveredEvent.amd.end === amdDay),
		currentZoomName: querystringParameters => 
			(querystringParameters.zoom && zooms[querystringParameters.zoom])
				? querystringParameters.zoom
				: 'top',
		currentZoom: currentZoomName => zooms[currentZoomName]
	},
	helpers: {
		multiplyIndentByWidth,
	},
	methods: {
		startHover(event) {
			this.set({
				hoveredEvent: event
			})
		},
		endHover() {
			this.set({
				hoveredEvent: null
			})
		},
		zoomTo(event) {
			const { type, amd } = event || 'default'
			const { start, end } = amd
			const zoomSettings = zooms[type] || zooms.default
			this.set(Object.assign({
				start,
				end
			}, zoomSettings))
		}
	},
	components: {
		VCenter,
		Events
	}
}
</script>
