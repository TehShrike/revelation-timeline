<div ref:element>
	{{yield}}
</div>

<script>
import globalUpdateEmitter from './motion-event.js'

export default {
	oncreate() {
		const componentListener = () => this.updateVisibility()
		globalUpdateEmitter.on('update', componentListener)

		this.set({
			listener: componentListener
		})
		this.updateVisibility()
	},
	ondestroy() {
		const componentListener = this.get('listener')
		globalUpdateEmitter.removeListener('update', componentListener)
	},
	methods: {
		updateVisibility() {
			const relativeToViewport = this.refs.element.firstElementChild.getBoundingClientRect()
			const viewportHeight = window.document.documentElement.clientHeight
			const visible = relativeToViewport.bottom >= 0 && relativeToViewport.top <= viewportHeight

			if (visible) {
				const topRatio = relativeToViewport.top / viewportHeight
				const bottomRatio = relativeToViewport.bottom / viewportHeight

				this.set({
					visible,
					top: relativeToViewport.top,
					bottom: relativeToViewport.bottom,
					topRatio,
					bottomRatio
				})
			} else {
				if (this.get('visible')) {
					this.set({
						visible,
						top: null,
						bottom: null,
						topRatio: null,
						bottomRatio: null,
					})
				}
			}
		}
	}
}
</script>
