<div ref:element data-whatever-thingy="{{updateOnChange}}">
	{{yield}}
</div>

<script>
import globalUpdateEmitter from './motion-event.js'

const average = (a, b) => (a + b) / 2

export default {
	oncreate() {
		const componentListener = () => this.updateVisibility()
		globalUpdateEmitter.on('update', componentListener)

		this.set({
			listener: componentListener
		})

		try {
			this.updateVisibility()
		} catch (e) {
			console.error('Error in oncreate for some reason', e)
		}


		this.observe('updateOnChange', () => {
			// https://github.com/sveltejs/svelte/issues/730
			Promise.resolve().then(() => {
				try {
					this.updateVisibility()
				} catch (e) {
					console.error('There was an error trying to update visibility', e)
				}
			})
		})
	},
	ondestroy() {
		const componentListener = this.get('listener')
		globalUpdateEmitter.removeListener('update', componentListener)
	},
	methods: {
		setNotVisible() {
			if (this.get('visible')) {
				this.set({
					visible: false,
					top: null,
					bottom: null,
					left: null,
					right: null,
					verticalCenter: null,
					topRatio: null,
					bottomRatio: null,
				})
			}
		},
		updateVisibility() {
			if (!this.refs.element) {
				// this.log('!!!!!!!!!!!No element found!!!!!!!!!!!!!!!!!!')
				this.setNotVisible()
				return
			}

			const relativeToViewport = this.refs.element.firstElementChild.getBoundingClientRect()
			const viewportHeight = window.document.documentElement.clientHeight
			const visible = relativeToViewport.bottom >= 0 && relativeToViewport.top <= viewportHeight

			if (visible) {
				const topRatio = relativeToViewport.top / viewportHeight
				const bottomRatio = relativeToViewport.bottom / viewportHeight

				this.set({
					visible,
					top: relativeToViewport.top,
					bottom: relativeToViewport.bottom,
					left: relativeToViewport.left,
					right: relativeToViewport.right,
					verticalCenter: average(relativeToViewport.top, relativeToViewport.bottom),
					topRatio,
					bottomRatio
				})
			} else {
				// this.log('No longer visible')
				this.setNotVisible()
			}
		},
		log(message) {
			const logName = this.get('logName')
			if (logName) {
				console.log('Visibility -', logName, '-', message)
			} else {
				console.log('no logName!!! -', message)
			}
		}
	}
}
</script>
