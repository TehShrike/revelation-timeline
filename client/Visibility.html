<div ref:element>
	{{yield}}
</div>

<script>
import globalUpdateEmitter from './motion-event.js'

export default {
	oncreate() {
		const componentListener = () => this.updateVisibility()
		globalUpdateEmitter.on('update', componentListener)

		this.set({
			listener: componentListener
		})
	},
	ondestroy() {
		const componentListener = this.get('listener')
		globalUpdateEmitter.removeListener('update', componentListener)
	},
	methods: {
		updateVisibility() {
			const relativeToViewport = this.refs.element.firstElementChild.getBoundingClientRect()
			const viewportHeight = window.document.documentElement.clientHeight
			const visible = relativeToViewport.bottom >= 0 && relativeToViewport.top <= viewportHeight
			const topIsAboveViewport = relativeToViewport.top < 0
			const bottomIsBelowViewport = relativeToViewport.bottom > viewportHeight

			const topRatio = visible
				? (topIsAboveViewport ? 0 : (relativeToViewport.top / viewportHeight))
				: null

			const bottomRatio = visible
				? (bottomIsBelowViewport ? viewportHeight : (relativeToViewport.bottom / viewportHeight))
				: null

			this.set({
				visible,
				topIsAboveViewport,
				top: relativeToViewport.top,
				bottom: relativeToViewport.bottom,
				topRatio,
				bottomRatio
			})
		}
	}
}
</script>
